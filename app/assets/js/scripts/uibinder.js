const path=require("path"),AuthManager=require("./assets/js/authmanager"),ConfigManager=require("./assets/js/configmanager"),DistroManager=require("./assets/js/distromanager"),Lang=require("./assets/js/langloader");let rscShouldLoad=!1,fatalStartupError=!1;const VIEWS={landing:"#landingContainer",loginOptions:"#loginOptionsContainer",login:"#loginContainer",settings:"#settingsContainer",welcome:"#welcomeContainer",waiting:"#waitingContainer",loginOffline:"#loginOfflineContainer"};let currentView;function switchView(e,t,o=500,n=500,a=()=>{},r=()=>{}){currentView=t,$(""+e).fadeOut(o,()=>{a(),$(""+t).fadeIn(n,()=>{r()})})}function getCurrentView(){return currentView}function showMainUI(e){isDev||(loggerAutoUpdater.log("Initializing.."),ipcRenderer.send("autoUpdateAction","initAutoUpdater",ConfigManager.getAllowPrerelease())),prepareSettings(!0),updateSelectedServer(e.getServer(ConfigManager.getSelectedServer())),setTimeout(()=>{document.getElementById("frameBar").style.backgroundColor="#0C0C0C",$("#main").show();var e=0<Object.keys(ConfigManager.getAuthAccounts()).length;!isDev&&e&&validateSelectedAccount(),(ConfigManager.isFirstLaunch()?(currentView=VIEWS.welcome,$(VIEWS.welcome)):e?(currentView=VIEWS.landing,$(VIEWS.landing)):(loginOptionsCancelEnabled(!1),loginOptionsViewOnLoginSuccess=VIEWS.landing,loginOptionsViewOnLoginCancel=VIEWS.loginOptions,currentView=VIEWS.loginOptions,$(VIEWS.loginOptions))).fadeIn(1e3),setTimeout(()=>{$("#loadingContainer").fadeOut(500,()=>{})},250)},750)}function showFatalStartupError(){setTimeout(()=>{$("#loadingContainer").fadeOut(250,()=>{document.getElementById("overlayContainer").style.background="none",setOverlayContent("Erro Fatal: Não foi possivel carregar o index de distribuição","Não foi possivel estabelecer uma conexão com os nossos servidores para baixar o index de distribuição. Nenhuma cópia local foi encontrada. <br><br>Certifique-se que você esta conectado a internet e reabra o launcher.","Fechar"),setOverlayHandler(()=>{remote.getCurrentWindow().close()}),toggleOverlay(!0)})},750)}function onDistroRefresh(e){updateSelectedServer(e.getServer(ConfigManager.getSelectedServer())),syncModConfigurations(e)}function syncModConfigurations(e){var t,o=[];for(t of e.getServers()){var n=t.getID(),a=t.getModules(),r=ConfigManager.getModConfiguration(n);if(null!=r){var i,s=r.mods,u={};for(i of a){var l,g=i.getType();g!==DistroManager.Types.ForgeMod&&g!==DistroManager.Types.LiteMod&&g!==DistroManager.Types.LiteLoader||(i.getRequired().isRequired()?i.hasSubModules()&&(g=i.getVersionlessID(),"object"==typeof(l=scanOptionalSubModules(i.getSubModules(),i)))&&(null==s[g]?u[g]=l:u[g]=mergeModConfiguration(s[g],l,!0)):null==s[g=i.getVersionlessID()]?u[g]=scanOptionalSubModules(i.getSubModules(),i):u[g]=mergeModConfiguration(s[g],scanOptionalSubModules(i.getSubModules(),i),!1))}o.push({id:n,mods:u})}else{var c,d={};for(c of a){var f=c.getType();f!==DistroManager.Types.ForgeMod&&f!==DistroManager.Types.LiteMod&&f!==DistroManager.Types.LiteLoader||(c.getRequired().isRequired()?c.hasSubModules()&&"object"==typeof(f=scanOptionalSubModules(c.getSubModules(),c))&&(d[c.getVersionlessID()]=f):d[c.getVersionlessID()]=scanOptionalSubModules(c.getSubModules(),c))}o.push({id:n,mods:d})}}ConfigManager.setModConfigurations(o),ConfigManager.save()}function scanOptionalSubModules(e,t){if(null!=e){var o,n={};for(o of e){var a=o.getType();a!==DistroManager.Types.ForgeMod&&a!==DistroManager.Types.LiteMod&&a!==DistroManager.Types.LiteLoader||(o.getRequired().isRequired()?o.hasSubModules()&&"object"==typeof(a=scanOptionalSubModules(o.getSubModules(),o))&&(n[o.getVersionlessID()]=a):n[o.getVersionlessID()]=scanOptionalSubModules(o.getSubModules(),o))}if(0<Object.keys(n).length)return e={mods:n},t.getRequired().isRequired()||(e.value=t.getRequired().isDefault()),e}return t.getRequired().isDefault()}function mergeModConfiguration(t,o,e=!1){if("boolean"==typeof t){if("boolean"==typeof o)return t;if("object"==typeof o)e||(o.value=t)}else if("object"==typeof t){if("boolean"==typeof o)return void 0===t.value||t.value;if("object"==typeof o){e||(o.value=void 0===t.value||t.value);var n=Object.keys(o.mods);for(let e=0;e<n.length;e++){var a=n[e];null!=t.mods[a]&&(o.mods[a]=mergeModConfiguration(t.mods[a],o.mods[a]))}}}return o}function refreshDistributionIndex(e,t,o){(e?DistroManager.pullRemote():DistroManager.pullLocal()).then(t).catch(o)}async function validateSelectedAccount(){const t=ConfigManager.getSelectedAccount();if(null==t||"mojang"!=t.type&&"microsoft"!=t.type)return!0;if(await AuthManager.validateSelected())return!0;{ConfigManager.removeAuthAccount(t.uuid),ConfigManager.save();const o=Object.keys(ConfigManager.getAuthAccounts()).length;setOverlayContent("Falha ao atualizar o login",`Não conseguimos atualizar o login para o usuário <strong>${t.displayName}</strong>. Por favor ${0<o?"selecione outra conta ou ":""} faça login novamente.`,"Login","Selecione outra conta"),setOverlayHandler(()=>{const e="microsoft"===t.type;e||(document.getElementById("loginUsername").value=t.username,validateEmail(t.username)),loginOptionsViewOnLoginSuccess=getCurrentView(),loginOptionsViewOnLoginCancel=VIEWS.loginOptions,0<o?(loginOptionsViewOnCancel=getCurrentView(),loginOptionsViewCancelHandler=()=>{e?ConfigManager.addMicrosoftAuthAccount(t.uuid,t.accessToken,t.username,t.expiresAt,t.microsoft.access_token,t.microsoft.refresh_token,t.microsoft.expires_at):ConfigManager.addMojangAuthAccount(t.uuid,t.accessToken,t.username,t.displayName),ConfigManager.save(),validateSelectedAccount()},loginOptionsCancelEnabled(!0)):loginOptionsCancelEnabled(!1),toggleOverlay(!1),switchView(getCurrentView(),VIEWS.loginOptions)}),setDismissHandler(()=>{if(1<o)prepareAccountSelectionList(),$("#overlayContent").fadeOut(250,()=>{bindOverlayKeys(!0,"accountSelectContent",!0),$("#accountSelectContent").fadeIn(250)});else{const t=ConfigManager.getAuthAccounts();setSelectedAccount(Array.from(Object.keys(t),e=>t[e])[0].uuid),toggleOverlay(!1)}}),toggleOverlay(!0,0<o)}}function setSelectedAccount(e){e=ConfigManager.setSelectedAccount(e);ConfigManager.save(),updateSelectedAccount(e),"mojang"===e.type||"microsoft"===e.type?validateSelectedAccount():prepareSettings(!1)}document.addEventListener("readystatechange",function(){"interactive"!==document.readyState&&"complete"!==document.readyState||rscShouldLoad&&(rscShouldLoad=!1,fatalStartupError?showFatalStartupError():showMainUI(DistroManager.getDistribution()))},!1),ipcRenderer.on("distributionIndexDone",(e,t)=>{t?(syncModConfigurations(t=DistroManager.getDistribution()),"interactive"===document.readyState||"complete"===document.readyState?showMainUI(t):rscShouldLoad=!0):(fatalStartupError=!0,"interactive"===document.readyState||"complete"===document.readyState?showFatalStartupError():rscShouldLoad=!0)});